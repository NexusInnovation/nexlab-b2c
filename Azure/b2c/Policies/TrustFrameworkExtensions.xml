<?xml version="1.0" encoding="utf-8"?>
<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                      xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06"
                      PolicySchemaVersion="0.3.0.0"
                      TenantId="{{tenantName}}.onmicrosoft.com"
                      PolicyId="B2C_1A_TrustFrameworkExtensions"
                      PublicPolicyUri="http://{{tenantName}}.onmicrosoft.com/B2C_1A_TrustFrameworkExtensions">
  <BasePolicy>
    <TenantId>{{tenantName}}.onmicrosoft.com</TenantId>
    <PolicyId>B2C_1A_TrustFrameworkLocalization</PolicyId>
  </BasePolicy>
  <BuildingBlocks />
  <ClaimsProviders>
    <ClaimsProvider>
      <DisplayName>Local Account SignIn</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="login-NonInteractive">
          <Metadata>
            <!-- Id généré pour les app registrations : https://learn.microsoft.com/en-us/azure/active-directory-b2c/tutorial-create-user-flows?pivots=b2c-custom-policy#register-the-identityexperienceframework-application -->
            <!-- Todo: AppId : ProxyIdentityExperienceFramework -->
            <Item Key="client_id">{{proxyIdentityExperienceFramework}}</Item>
            <!-- Todo: AppId : IdentityExperienceFramework -->
            <Item Key="IdTokenAudience">{{identityExperienceFramework}}</Item>
          </Metadata>
          <InputClaims>
            <!-- Todo: AppId : ProxyIdentityExperienceFramework -->
            <InputClaim ClaimTypeReferenceId="client_id"
                        DefaultValue="{{proxyIdentityExperienceFramework}}" />
            <!-- Todo: AppId : IdentityExperienceFramework -->
            <InputClaim ClaimTypeReferenceId="resource_id"
                        PartnerClaimType="resource"
                        DefaultValue="{{identityExperienceFramework}}" />
          </InputClaims>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
    <ClaimsProvider>
      <Domain>live.com</Domain>
      <DisplayName>Microsoft Account</DisplayName>
      <TechnicalProfiles>
      <!-- Todo: Enlever cela-->
        <TechnicalProfile Id="MSA-MicrosoftAccount-OpenIdConnect">
          <DisplayName>Microsoft Account</DisplayName>
          <Protocol Name="OpenIdConnect" />
          <Metadata>
            <Item Key="ProviderName">https://login.live.com</Item>
            <Item Key="METADATA">https://login.live.com/.well-known/openid-configuration</Item>
            <Item Key="response_types">code</Item>
            <Item Key="response_mode">form_post</Item>
            <Item Key="scope">openid profile email</Item>
            <Item Key="HttpBinding">POST</Item>
            <Item Key="UsePolicyInRedirectUri">false</Item>
            <!-- Todo: À paramétrisé ClientId de l'app registration dans Azure AD -->
            <Item Key="client_id">{{adClientId}}</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="client_secret"
                 StorageReferenceId="B2C_1A_MSASecret" />
          </CryptographicKeys>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="issuerUserId"
                         PartnerClaimType="oid" />
            <OutputClaim ClaimTypeReferenceId="givenName"
                         PartnerClaimType="given_name" />
            <OutputClaim ClaimTypeReferenceId="surName"
                         PartnerClaimType="family_name" />
            <OutputClaim ClaimTypeReferenceId="displayName"
                         PartnerClaimType="name" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource"
                         DefaultValue="socialIdpAuthentication" />
            <OutputClaim ClaimTypeReferenceId="identityProvider"
                         PartnerClaimType="iss" />
            <OutputClaim ClaimTypeReferenceId="email" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CreateRandomUPNUserName" />
            <OutputClaimsTransformation ReferenceId="CreateUserPrincipalName" />
            <OutputClaimsTransformation ReferenceId="CreateAlternativeSecurityId" />
            <OutputClaimsTransformation ReferenceId="CreateSubjectClaimFromAlternativeSecurityId" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-SocialLogin" />
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
    <ClaimsProvider>
      <DisplayName>Rest API</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="Rest-Enhance-Claims">
          <DisplayName>API Sign In</DisplayName>
           <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ServiceUrl">{{apiUrl}}</Item>
            <Item Key="AuthenticationType">Basic</Item> 
            <Item Key="SendClaimsIn">QueryString</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="BasicAuthenticationUsername" StorageReferenceId="B2C_1A_RestApiUsername" />
            <Key Id="BasicAuthenticationPassword" StorageReferenceId="B2C_1A_RestApiPassword" />
          </CryptographicKeys>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="email" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="contactId" />
            <OutputClaim ClaimTypeReferenceId="errorMessage" />
            <OutputClaim ClaimTypeReferenceId="notFound" />
            <OutputClaim ClaimTypeReferenceId="displayName" />
          </OutputClaims>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
  </ClaimsProviders>
  <SubJourneys>
    <SubJourney Id="PasswordReset" Type="Call">
      <OrchestrationSteps>
        <!-- Validate user's email address. -->
        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="PasswordResetUsingEmailAddressExchange" TechnicalProfileReferenceId="LocalAccountDiscoveryUsingEmailAddress" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <!-- Collect and persist a new password. -->
        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="NewCredentials" TechnicalProfileReferenceId="LocalAccountWritePasswordUsingObjectId" />
          </ClaimsExchanges>
        </OrchestrationStep>
      </OrchestrationSteps>
    </SubJourney>
  </SubJourneys>
</TrustFrameworkPolicy>